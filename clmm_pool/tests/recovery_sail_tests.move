module clmm_pool::recovery_sail_tests {
    #[allow(unused_const)]
    const COPYRIGHT_NOTICE: vector<u8> = b"Â© 2025 Metabyte Labs, Inc.  All Rights Reserved.";
    #[allow(unused_const)]
    const PATENT_NOTICE: vector<u8> = b"Patent pending - U.S. Patent Application No. 63/861,982";

    use sui::test_scenario;
    use integer_mate::i32;
    use clmm_pool::tick;
    use sui::test_utils;

    #[test_only]
    public struct TestCoinA has drop, store {}
    #[test_only]
    public struct TestCoinB has drop, store {}

    /*
    state before the bug fix:
    sqrt price: 2062269596072228240
    tick index: -43824
    liquidity: 13062581757983628
    staked liquidity: 43409834894446722
    */
    #[test_only]
    fun current_tick_index(): i32::I32 {
        i32::from(35922)
    }

    fun current_liqudity(): u128 {
        132973003280830   
    }

    fun current_staked_liquidity(): u128 {
        132948389901173
    }

    #[test_only] 
    fun setup_tick_manager(ctx: &mut sui::tx_context::TxContext): tick::TickManager {
        tick::new_test(

50,
12345u64, // You can change this seed value

vector<u32>[
  4294523696, 0, 17100, 28100, 28300, 29000, 29400, 29450, 29550, 29600, 29950, 30000, 30450, 31000, 31050, 32150, 32200, 33450, 33500, 34050, 34150, 34200, 34250, 34350, 34400, 34550, 34600, 34700, 34750, 34850, 35050, 35200, 35300, 35350, 35400, 35600, 35700, 35800, 35900, 35950, 36000, 36050, 36150, 36200, 36250, 36300, 36350, 36400, 36550, 36600, 36750, 36850, 36900, 36950, 37200, 37300, 37350, 37400, 37700, 38050, 39250, 40400, 40450, 40550, 40600, 42550, 443600
],

vector<u128>[
  4302785677, 18446744073709551616, 43373347293321488973, 75174917890306466522, 75930400412963788024, 78634881562722604964, 80223331325111225157, 80424130508033165752, 80827237934338885943, 81029548696893472837, 82459973996755659760, 82666371501431835062, 84547352499713213311, 86904549754575032004, 87122072042601178188, 92047754432894000940, 92278150174065859151, 98229272592989684986, 98475140688341577368, 101220647489438365441, 101727992666075251425, 101982618065821560888, 102237880793529396020, 102750324617755933484, 103007508916729956976, 103782930660097757413, 104042699574372063184, 104564189636948930656, 104825914044240179267, 105351329788912700850, 106410075054326474876, 107211110695108998791, 107748481688499673624, 108018176386123855286, 108288546130196829386, 109376809427334184126, 109925035486693071758, 110476009402875849009, 111029744948881802755, 111307652655997778926, 111586255966744205814, 111865556622218571204, 112426256953541831743, 112707660133419216908, 112989767666103418607, 113272581314591133203, 113556102846291841850, 113840334033038855700, 114697303308481014019, 114984390922611092655, 115849972449695421932, 116430643747436349115, 116722069916674009560, 117014225526283920868, 118486009242788776610, 119079893067672970925, 119377950314055809780, 119676753598412253748, 121485345000575435085, 123629941803173344604, 131274396656357659111, 139043507628489872408, 139391533848060014040, 140090201798877158880, 140440847896364501106, 154822842870922170742, 79084200890414257525634219231
],

vector<u128>[
  58878283, 2787235434, 1648154645, 39776795994699, 656126489, 340282366920938463463374602878453318103, 7256972, 145381272, 40070261, 107216852, 31598418128650, 340282366920938463463374572208287110110, 363740867, 28639549732789, 340282366920938463463374575833350082806, 25246747468969, 340282366920938463463374578792218478667, 216961564, 340282366920938463463374598623224899917, 30939546255, 18482519473, 8594878443, 15975511629, 38443657709, 1192880073, 13458022966, 16789399144, 4588259720, 2502067616, 296119446, 5149503779, 6520197461, 2047827439, 503535389, 540459606, 16968289896, 340282366920938463463374607431551249892, 4944142433, 116341048243848, 340282366920938463463374491089527087535, 340282366920938463463374607426824069023, 340282366920938463463374607428081781064, 340282366920938463463374607417379877992, 340282366920938463463374607414490887284, 340282366920938463463374607400085915406, 340282366920938463463374607431227751850, 340282366920938463463374607392670851285, 340282366920938463463374607431160408443, 340282366920938463463374607418310188490, 340282366920938463463374607414978812312, 340282366920938463463374607429266143840, 340282366920938463463374590993561720229, 340282366920938463463374607428980976022, 340282366920938463463374607404515095593, 340282366920938463463374607425248013995, 340282366920938463463374607429720384017, 340282366920938463463374607431276191186, 340282366920938463463374607426607192558, 340282366920938463463374607431474425807, 340282366920938463463374607430120056811, 340282366920938463463374607431112084967, 340282366920938463463374607431760954484, 340282366920938463463374607431622830184, 340282366920938463463374607431728141195, 340282366920938463463374607431660994604, 340282366920938463463374607431404470589, 340282366920938463463374607431709333173
],

vector<u128>[
  58878283, 2787235434, 1648154645, 39776795994699, 656126489, 75000277096045, 7256972, 145381272, 40070261, 107216852, 31598418128650, 35223481101346, 363740867, 28639549732789, 31598418128650, 25246747468969, 28639549732789, 216961564, 41684614533137, 30939546255, 18482519473, 8594878443, 15975511629, 38443657709, 1192880073, 13458022966, 16789399144, 4588259720, 2502067616, 296119446, 5149503779, 6520197461, 2047827439, 503535389, 540459606, 16968289896, 216961564, 4944142433, 116341048243848, 116342241123921, 4944142433, 3686430392, 14388333464, 17277324172, 31682296050, 540459606, 39097360171, 607803013, 13458022966, 16789399144, 2502067616, 16438206491227, 2787235434, 27253115863, 6520197461, 2047827439, 492020270, 5161018898, 293785649, 1648154645, 656126489, 7256972, 145381272, 40070261, 107216852, 363740867, 58878283
],

vector<u128>[
  63350716399970, 113711188004362, 550473625606095, 94105899917268, 569708333495581, 91404501886798, 196298644535183, 187348310930401, 105892803994165, 92973436599248, 88933530746063, 91404501886798, 166193211628021, 85949917253531, 88933530746063, 84035624467922, 85949917253531, 559216404498224, 0, 547151308738777, 526383178385540, 559128722944296, 573745760520016, 576697897411499, 420140901760285, 398185223248025, 591663751600094, 591663751600094, 591663751600094, 591663751600094, 97933377526838, 176620571462902, 208292237286848, 204656383846704, 591663751600094, 591663751600094, 591663751600094, 591663751600094, 591663751600094, 0, 0, 0, 191716249401801, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
],

vector<u128>[
  1973019008172, 34363305623364, 4902785198727699, 28793370653154, 5523106012896872, 2042939879668, 2221907417048219, 2221748436168069, 29287513576793, 14768270388323, 2042939879668, 2042939879668, 110423810021193, 2042939879668, 2042939879668, 2042939879668, 2042939879668, 5478823962978493, 0, 3936627525389791, 3891102457412412, 5478823962978493, 5802219427630430, 7262472734671315, 3603502773912150, 3103729828676521, 7673954430293111, 7673954430293111, 7673954430293111, 7673954430293111, 28793370653154, 610528516005074, 2386910812123887, 2856072375439997, 7673954430293111, 7673954430293111, 7673954430293111, 7673954430293111, 7673954430293111, 0, 0, 0, 3080434788962309, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
],

vector<u128>[
  340032317929561, 1382929069774030, 63215004929732987, 875293726878195, 108498226424081652, 603403061774767, 14707640625503145, 14410711860834606, 1128077193694939, 709705442834973, 564238401664314, 603403061774767, 6740414962526705, 532894238747401, 564238401664314, 500383900047385, 532894238747401, 80787106711991084, 0, 50943695134772914, 46895793685430340, 79216957363786077, 182983587515833716, 318171640661669029, 28564342563545028, 24539928577645488, 710360099666924112, 644323216315949588, 756574094017241798, 781543297775247797, 970378195146915, 9971205182915422, 184747157073132768, 272571873546222437, 739011338208998810, 806385512761629377, 716677732033162273, 796937022813135636, 766089855179372929, 0, 0, 0, 21843205174986642, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
],

vector<vector<u128>>[
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[]
],

vector<u128>[
  46089114, 2787235434, 1648154645, 39776795994699, 656126489, 340282366920938463463374602878453318103, 7256972, 0, 40070261, 107216852, 31598418128650, 340282366920938463463374572208287110110, 363740867, 28639549732789, 340282366920938463463374575833350082806, 25246747468969, 340282366920938463463374578792218478667, 0, 340282366920938463463374598623224899917, 30939546255, 4943516952, 8594878443, 15975511629, 37832456898, 0, 6888925135, 16789399144, 4588259720, 2502067616, 296119446, 5149503779, 6517017190, 0, 11515119, 540459606, 16968289896, 0, 4944142433, 116341048243848, 340282366920938463463374491090719967608, 340282366920938463463374607426824069023, 340282366920938463463374607428081781064, 340282366920938463463374607429542212453, 340282366920938463463374607415867555344, 340282366920938463463374607400085915406, 340282366920938463463374607431227751850, 340282366920938463463374607393040414952, 340282366920938463463374607431402045587, 340282366920938463463374607424879286321, 340282366920938463463374607414978812312, 340282366920938463463374607429266143840, 340282366920938463463374590993561720229, 340282366920938463463374607428980976022, 340282366920938463463374607404515095593, 340282366920938463463374607425251194266, 0, 0, 340282366920938463463374607426607192558, 340282366920938463463374607431474425807, 340282366920938463463374607430120056811, 340282366920938463463374607431112084967, 340282366920938463463374607431760954484, 0, 340282366920938463463374607431728141195, 340282366920938463463374607431660994604, 340282366920938463463374607431404470589, 340282366920938463463374607431722122342
],

vector<u128>[
  0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 453822833506615514u128, 385485079508856420u128, 503196118512033837u128, 530080891555183872u128, 0u128, 0u128, 0u128, 0u128, 484337237063132965u128, 552630001772747213u128, 460742142033096163u128, 544360848609370928u128, 513451289675001834u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128
],
            ctx
        )
    }

    #[test]
    fun test_recovery_sail() {
        let mut scenario = test_scenario::begin(@0x1);
        let tick_manager = setup_tick_manager(scenario.ctx());

        let (calculated_liquidity, calculated_staked_liquidity) = tick_manager.calc_current_liquidity(current_tick_index());

        assert!(calculated_liquidity == current_liqudity(), 1);
        assert!(calculated_staked_liquidity <= current_liqudity(), 2);
        assert!(calculated_staked_liquidity == current_staked_liquidity(), 3);

        test_utils::destroy(tick_manager);
        scenario.end();
    }

}