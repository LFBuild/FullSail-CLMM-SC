module clmm_pool::recovery_usdt_tests {
    #[allow(unused_const)]
    const COPYRIGHT_NOTICE: vector<u8> = b"Â© 2025 Metabyte Labs, Inc.  All Rights Reserved.";
    #[allow(unused_const)]
    const PATENT_NOTICE: vector<u8> = b"Patent pending - U.S. Patent Application No. 63/861,982";

    use sui::test_scenario;
    use integer_mate::i32;
    use clmm_pool::tick;
    use sui::test_utils;

    #[test_only]
    public struct TestCoinA has drop, store {}
    #[test_only]
    public struct TestCoinB has drop, store {}

    /*
    state before the bug fix:
    sqrt price: 2062269596072228240
    tick index: -43824
    liquidity: 13062581757983628
    staked liquidity: 43409834894446722
    */
    #[test_only]
    fun current_tick_index(): i32::I32 {
        i32::neg_from(4)
    }

    fun current_liqudity(): u128 {
        11920545885423335   
    }

    fun current_staked_liquidity(): u128 {
        11911445302770078
    }

    #[test_only] 
    fun setup_tick_manager(ctx: &mut sui::tx_context::TxContext): tick::TickManager {
        tick::new_test(
1,
12345u64, // You can change this seed value

vector<u32>[
  4294951200, 4294966237, 4294966241, 4294967145, 4294967191, 4294967192, 4294967193, 4294967197, 4294967246, 4294967270, 4294967272, 4294967273, 4294967274, 4294967275, 4294967278, 4294967281, 4294967282, 4294967285, 4294967286, 4294967287, 4294967288, 4294967289, 4294967290, 4294967291, 4294967292, 4294967293, 4294967294, 4294967295, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 11, 13, 14, 16, 17, 19, 22, 23, 31, 95, 96, 97, 101, 168, 948, 952, 23027
],

vector<u128>[
  8249298110904801142, 17495444438959818406, 17498943702802054758, 18308002501369429971, 18350157258808598456, 18351074743734989126, 18351992274534479313, 18355662856509308956, 18400687111524538688, 18422780084560923885, 18424622362569379978, 18425543570657881958, 18426464824805636915, 18427386125014947747, 18430150302035246292, 18432914893692463368, 18433836516397156361, 18436601661000350799, 18437523468038800957, 18438445321166450835, 18439367220385604838, 18440289165698567478, 18441211157107643397, 18442133194615137336, 18443055278223354162, 18443977407934598850, 18444899583751176498, 18445821805675392311, 18446744073709551616, 18447666387855959850, 18448588748116922571, 18449511154494745446, 18450433606991734263, 18451356105610194921, 18452278650352433436, 18453201241220755940, 18454123878217468680, 18455046561344878016, 18456892066001012504, 18458737755207612605, 18459660669023104391, 18461506635090006701, 18462429687346031680, 18464275930314766283, 18467045640944194262, 18467968970143588539, 18475357265883657906, 18534570138610771039, 18535496843950647243, 18536423595624632116, 18540131065707992999, 18602341538671687185, 19342127944018109271, 19345996563028192333, 58333720261122670625
],

vector<u128>[
  9533523, 75791806, 1968655769, 9637090796, 22453484184, 20858878910, 10188699219, 6198216490, 46535687881, 147194000202, 16969054562, 7142901389, 2741367485, 611605723115, 2448776980868, 10388880960, 1315159231593, 19208002342420, 9536953050795, 8364258227521, 29416126505110, 4477248082584, 808385917145, 44128619868447, 11799928387250561, 340282366920938463463363231317810689597, 340282366920938463463374184911182045699, 340282366920938463463374584998750062161, 340282366920938463463374604464085157616, 51125052227677, 340282366920938463463374577741134663400, 340282366920938463463374523127581827119, 340282366920938463463374604713877006693, 340282366920938463463374594442606271383, 340282366920938463463374606468456909697, 340282366920938463463374597265543485204, 340282366920938463463374604770847903060, 340282366920938463463374606997996263756, 340282366920938463463374607301978551040, 340282366920938463463374607204322539146, 340282366920938463463374607284574211254, 340282366920938463463374607412057789409, 340282366920938463463374607424625310067, 340282366920938463463374606925498814932, 340282366920938463463374604982991230588, 340282366920938463463374607326431884865, 340282366920938463463374607385232523575, 340282366920938463463374607409314727272, 340282366920938463463374607405888343353, 340282366920938463463374607426600501430, 340282366920938463463374607425569994966, 340282366920938463463374607422131120660, 340282366920938463463374607431692419650, 340282366920938463463374607429799555687, 340282366920938463463374607431758677933
],

vector<u128>[
  9533523, 75791806, 1968655769, 9637090796, 22453484184, 20858878910, 10188699219, 6198216490, 46535687881, 147194000202, 16969054562, 7142901389, 2741367485, 611605723115, 2448776980868, 10388880960, 1315159231593, 19208002342420, 9536953050795, 8364258227521, 29416126505110, 4477248082584, 808385917145, 44128619868447, 11799928387250561, 11985020138536975, 427842426782549, 22433018149295, 2967683053840, 68533342707163, 29690633548056, 84304186384337, 2717891204763, 12989161940073, 963311301759, 10166224726252, 2660920308396, 433771947700, 129789660416, 227445672310, 147194000202, 19710422047, 7142901389, 506269396524, 2448776980868, 105336326591, 46535687881, 22453484184, 25879868103, 5167710026, 6198216490, 9637090796, 75791806, 1968655769, 9533523
],

vector<u128>[
  5218838441646, 2366264280019, 2733379777393, 5180788101686, 426735405848, 984237373745, 984237373745, 5066098199168, 5006913171749, 5032119678453, 5218838441646, 2966688444373, 2924337417716, 3903118241773, 4491625262457, 5011458160690, 4998829830610, 5022396734354, 982731882794, 3844355888740, 2991373960371, 2936510777877, 3953767357867, 4495495805705, 3846971567541, 644490113370, 767025099454, 618625194175, 533864630109, 360406987867, 239807376346, 102599684849, 38449612619, 17102691932, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
],

vector<u128>[
  5236340428418, 2078852361505, 2819149050630, 5213867271998, 195542552305, 842669612394, 842669612394, 5111701954604, 4986211664258, 5018857852240, 5236340428418, 2926694549710, 2925838909233, 3928348084184, 4541185803898, 4990075784748, 4976781179299, 5001403225031, 840919293569, 3683854117827, 2926694549710, 2939061863148, 3978363649322, 4529774783385, 3730998441175, 608099190733, 826820305193, 618721054270, 533966778658, 360497778278, 239879125788, 102639801064, 38468575844, 17111725954, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
],

vector<u128>[
  50843240640694347917739, 50840544731598258773867, 50841975121345969481925, 50843239845517895543489, 50838215117615688128392, 50838980961943860064989, 50838998986588064468230, 50843235910274571918498, 50843228942377067937408, 50843233545288090130868, 50843241628174144396135, 50842519462984732687920, 50842495426260009507312, 50842837240759655817844, 50843130584984691331581, 50843231059490810172220, 50843222872164338918952, 50843232257746708269825, 50838815984720653355246, 50842798603374614290107, 50842530978311472047196, 50842489459086200096733, 50842838319725777720565, 50843117629043367894507, 50842710281191987255633, 108929626889998559, 196419374467361874, 121312531956999008, 105615983097268250, 61365695893287263, 36089054512746876, 2331008138005151, 1076991630136, 645287199420, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
],

vector<vector<u128>>[
  vector<u128>[459796811462855840, 11983723571170619],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[459796596096374909, 11133412479287019],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[455289850651258947, 6253400870895405],
  vector<u128>[445806529101720182],
  vector<u128>[452357079716502221, 3320629936138679],
  vector<u128>[459796811462855840, 11983723571170619],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[257901391928997667],
  vector<u128>[449274493803854930, 238044023491388],
  vector<u128>[435623697065154592],
  vector<u128>[450760426217170457, 1723976436806915],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[27506172226837, 83584156908],
  vector<u128>[18650814398462916, 3068500831599131],
  vector<u128>[226132325663251003, 4241648153453669],
  vector<u128>[206088711798014328, 5072867718204027],
  vector<u128>[208111368917213555, 6661184117499393],
  vector<u128>[239950231643006414, 6635704246971860],
  vector<u128>[230734372644653205, 5952007906201960],
  vector<u128>[206946714686030238, 5722757209235445],
  vector<u128>[125373173496012457, 4947023506086015],
  vector<u128>[76778465346660150, 3830502782953827],
  vector<u128>[2893629365193651, 2886965454925751],
  vector<u128>[2426183634941],
  vector<u128>[1453665190389],
  vector<u128>[0, 0],
  vector<u128>[0],
  vector<u128>[0, 0],
  vector<u128>[0, 0],
  vector<u128>[0],
  vector<u128>[0, 0],
  vector<u128>[0, 0],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[0],
  vector<u128>[0],
  vector<u128>[0],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[0, 0],
  vector<u128>[0, 0],
  vector<u128>[],
  vector<u128>[],
  vector<u128>[0, 0]
],

vector<u128>[
  9533523, 0, 1949182767, 9637090796, 9960526603, 20239840557, 0, 0, 0, 147194000202, 16969054562, 6159117441, 0, 105336326591, 2448776980868, 10388880960, 0, 19208002342420, 9498914719652, 8346637651594, 27053463205950, 1168854705934, 198455282386, 43498872120108, 11799695482207164, 340282366920938463463363223135752590426, 340282366920938463463374184240374316406, 340282366920938463463374584998750062161, 340282366920938463463374606427019989443, 46197885340846, 340282366920938463463374580074807572636, 340282366920938463463374531370688974830, 340282366920938463463374604724144064058, 340282366920938463463374595072354019722, 340282366920938463463374606701161031874, 340282366920938463463374605447601584375, 340282366920938463463374605441856553573, 340282366920938463463374606997996263756, 340282366920938463463374607301978551040, 340282366920938463463374607233312929070, 340282366920938463463374607284574211254, 340282366920938463463374607414799156894, 340282366920938463463374607425609094015, 0, 340282366920938463463374604982991230588, 340282366920938463463374607326431884865, 0, 340282366920938463463374607421807684853, 340282366920938463463374607411528370899, 0, 0, 340282366920938463463374607422131120660, 0, 340282366920938463463374607429819028689, 340282366920938463463374607431758677933
],

vector<u128>[
  67969602322550u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 981598112042662u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 802869805470269u128, 430901945215462u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128, 0u128
],
            ctx
        )
    }

    #[test]
    fun test_recovery_usdt() {
        let mut scenario = test_scenario::begin(@0x1);
        let tick_manager = setup_tick_manager(scenario.ctx());

        let (calculated_liquidity, calculated_staked_liquidity) = tick_manager.calc_current_liquidity(current_tick_index());

        assert!(calculated_liquidity == current_liqudity(), 1);
        assert!(calculated_staked_liquidity <= current_liqudity(), 2);
        assert!(calculated_staked_liquidity == current_staked_liquidity(), 3);

        test_utils::destroy(tick_manager);
        scenario.end();
    }

}